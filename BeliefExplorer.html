<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Belief Explorer</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<link rel="stylesheet" href="mini-default.min.css">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-3425939-8"></script>
<script>

function gtag(){dataLayer.push(arguments);}

var Database = {};
var locationNoVars = "";
var variables = {}

function ProcessWithPush(sectionName, itemChosen)
{
    history.pushState(sectionName, "", locationNoVars + "?q="+sectionName);
    Process(sectionName, itemChosen)
}

function Process(sectionName, itemChosen)
{
    gtag('event', 'page', {'id':sectionName});    

    variables[sectionName] = itemChosen;
    item = Database[sectionName];
 
    $("#question").html(item.question.replace(/(<.*>)/, itemChosen))
    var a="<ul>";
    for(var key in item.answers)
    {
        var res = "";
        var match = key.match(/\$(.*)\$/);
        if (match!=null && match.length==2)
            res = match[1]

        var answer = key.replace(/(\$)/g,"");
        var nextSectionName = item.answers[key];

        var onClick = 'ProcessWithPush("'+nextSectionName+'", "'+res+'");return false;';

        a+="<li>";
        if (Database[nextSectionName]!=undefined)
            a+="<a href=''onclick='"+onClick+"'>"+answer+"</a>";
        else
            a+="<div>"+answer+"</div>";
        a+="</li>";
    }
    a+="</ul>";
    $("#answers").html(a)
}

window.onpopstate = function(event) 
{
    if (event.state!==null)
        Process(event.state, "");
};

function Validate(itemName)
{
    var orphan = []
    for(var key1 in Database)
    {
        var responses = Database[key1].answers
        for(var key2 in responses)
        {
            var dest = Database[responses[key2]]
            if (dest==undefined)
                orphan.push(responses[key2]);
        }
    }
    return orphan;
}

$(document).ready(function()
{
    window.dataLayer = window.dataLayer || [];
    gtag('js', new Date());
    gtag('config', 'UA-3425939-8');

    var startingPoint = "0244388211625568";

    splitUrl = window.location.href.split("?");
    locationNoVars = splitUrl[0]
    if (splitUrl.length==2)
    {
        startingPoint =  splitUrl[1].split("=")[1]; 
    }
    
    history.replaceState(startingPoint, "", locationNoVars + "?q="+startingPoint);

    // Parse JSON 
    //
    function processJSON(data)
    {
        if (data.res!="OK") 
		{
		    alert(data.res);
		    return;
		}

        Database = {}
    
        var nodes = data["nodes"];
        for(var node in nodes)
        {
            var n = nodes[node];
            Database[n["id"]]={question:n["q"], answers:{}};
        }    
    
        var edges = data["edges"];
        for(var edge in edges)
        {
            var e = edges[edge];
            Database[e["s"]].answers[e["l"]] = e["t"];
        }    
    
        Validate(startingPoint);
        Process(startingPoint,  "");
    }
    
    $.ajax({
            type: "GET",
            url: "./SEMapDatabase.php",
            dataType: "json",
            success: function(data)
    	    {
    		    processJSON(data);
	        },
            error: function(XMLHttpRequest, textStatus, errorThrown) 
            { 
                $.ajax({
                        type: "GET",
                        url: "./SEMap_en.json",
                        dataType: "json",
                        success: function(data)
                	    {
                		    processJSON(data);
            	        }
                });    
            } 
	    });    
    })

</script>
</head>
<body>
    <header  class="sticky">
        <a href="#" class="logo">Belief Explorer</a>
    </header>
	<div class="container">
        <div class="row">
            <div class="col-sm"></div>
            <div class="col-lg-4 col-md-6  col-sm-12" style="height: calc(100vh - 10.25rem); display: flex; align-items: center; flex: 0 1 auto;">
                <form class="shadowed">
                    <fieldset>
                        <div id="question"></div>
                        <br>
                        <div class="input-group" id="answers"></div>
                    </fieldset>
                </form>
            </div>
            <div class="col-sm"></div>
        </div>
    </div>

    <footer class="sticky">
        <p>MIT License | <a href="#">About</a> | <a href="https://github.com/aguaviva/SEMap">Github code</a></p>
    </footer>
</body>
</html>

